<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>policypool feed</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        line-height: 1.5;
        font-size: 16px;
        --accent: #ff6600;
        --bg: #f7f7f7;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: #333;
      }

      header {
        background: #fff;
        border-bottom: 3px solid var(--accent);
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      header .brand {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent);
        text-transform: lowercase;
        letter-spacing: 0.03em;
      }

      header nav {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .cta {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 0.25rem;
        padding: 0.5rem 0.9rem;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1rem 4rem;
      }

      .hero {
        background: #fff;
        border: 1px solid #ececec;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .hero h1 {
        margin: 0 0 0.75rem;
        font-size: 2rem;
      }

      .hero p {
        margin: 0 0 1.25rem;
        color: #555;
      }

      .feed-list {
        background: #fff;
        border: 1px solid #ececec;
        border-radius: 0.5rem;
        padding: 0;
        margin: 0;
      }

      .feed-list ol {
        list-style: decimal;
        padding-left: 2.5rem;
        margin: 0;
      }

      .feed-item {
        padding: 0.85rem 1.25rem;
        border-top: 1px solid #f0f0f0;
      }

      .feed-item:first-child {
        border-top: none;
      }

      .feed-item a.title {
        font-weight: 600;
        color: #222;
        text-decoration: none;
      }

      .feed-item a.title:hover {
        text-decoration: underline;
      }

      .meta {
        font-size: 0.85rem;
        color: #777;
        margin-top: 0.25rem;
      }

      .status {
        padding: 0.85rem 1.25rem 1.25rem;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">policypool</div>
      <nav>
        <a class="cta" href="/submit.html">Submit a link</a>
      </nav>
    </header>

    <main>
      <section class="hero">
        <h1>Fresh writing from former federal employees</h1>
        <p>
          The policypool feed highlights essays, reports, and analysis from recently departed government experts. Every
          item shown below is sourced from Google Form responses that have been marked <strong>approved</strong> in the
          linked Google Sheet.
        </p>
        <p>
          Use the button above to contribute new pieces. Approved responses will appear here automatically.
        </p>
      </section>

      <section class="feed-list" aria-label="Latest approved submissions">
        <ol id="feed"></ol>
        <p id="feed-status" class="meta status" role="status"></p>
      </section>
    </main>

    <template id="feed-item-template">
      <li class="feed-item">
        <a class="title" href="" target="_blank" rel="noopener noreferrer"></a>
        <div class="meta"></div>
      </li>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      const SHEET_CSV_URL =
        "https://docs.google.com/spreadsheets/d/1zTYk2Jz4W_AMvS8ukp0UR2AQ5SSbI2CBp_ZedPpqiCs/export?format=csv&gid=0";

      const feedList = document.querySelector("#feed");
      const status = document.querySelector("#feed-status");
      const template = document.querySelector("#feed-item-template");

      function setStatus(message) {
        status.textContent = message;
        status.style.display = message ? "block" : "none";
      }

      function buildNameNode(name, linkedin) {
        if (!name) return null;
        if (linkedin) {
          const link = document.createElement("a");
          link.href = linkedin;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = name;
          return link;
        }

        const span = document.createElement("span");
        span.textContent = name;
        return span;
      }

      async function loadFeed() {
        setStatus("Loading latest submissions...");
        feedList.innerHTML = "";

        try {
          const response = await fetch(SHEET_CSV_URL);
          if (!response.ok) {
            throw new Error(`Failed to fetch sheet: ${response.status}`);
          }

          const csvText = await response.text();
          const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
          const rows = Array.isArray(parsed.data) ? parsed.data : [];

          const approvedRows = rows.filter((row) => {
            const approved = (row["Approved?"] || "").trim().toUpperCase();
            return approved === "Y" || approved === "YES";
          });

          if (!approvedRows.length) {
            setStatus("No approved submissions yet. New pieces will appear once the editors mark them approved.");
            return;
          }

          approvedRows.forEach((row, index) => {
            const clone = template.content.cloneNode(true);
            const li = clone.querySelector(".feed-item");
            const titleLink = clone.querySelector(".title");
            const meta = clone.querySelector(".meta");

            const pieceTitle = (row["Title of Piece"] || "Untitled submission").trim();
            const pieceUrl = (row["Link to piece"] || "").trim();
            titleLink.href = pieceUrl || "#";
            titleLink.textContent = pieceTitle;

            const submitterName = (row["Name"] || "").trim();
            const linkedin = (row["Linkedin"] || "").trim();
            const authors = (row["Authors, fill out if multiple authors with comma separation"] || "").trim();
            const tags = (row["Tags for agencies e.g. NSF, OSTP, DOC, DOE, etc"] || "").trim();

            const nameNode = buildNameNode(submitterName, linkedin);
            if (nameNode) {
              meta.append("By ");
              meta.append(nameNode);
            }

            if (authors) {
              if (meta.textContent) meta.append(" • ");
              meta.append(`Authors: ${authors}`);
            }

            if (tags) {
              if (meta.textContent) meta.append(" • ");
              meta.append(`Tags: ${tags}`);
            }

            li.setAttribute("data-approval-index", index);
            feedList.appendChild(clone);
          });

          setStatus("");
        } catch (error) {
          console.error(error);
          setStatus("We couldn't load the feed right now. Please refresh or try again later.");
        }
      }

      loadFeed();
    </script>
  </body>
</html>
